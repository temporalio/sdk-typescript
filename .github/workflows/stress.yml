name: Stress tests

on:
  workflow_call:
    inputs:
      test-type:
        required: true
        type: string
      test-timeout-minutes:
        required: true
        type: number

env:
  TEMPORAL_TESTING_LOG_DIR: /tmp/worker-logs
  TEMPORAL_TESTING_MEM_LOG_DIR: /tmp/worker-mem-logs
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  stress-test:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Print build info
        run: 'echo test-type: ${{ inputs.test-type }}, test-timeout-minutes: ${{ inputs.test-timeout-minutes }}'
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - uses: arduino/setup-protoc@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}
      - uses: Swatinem/rust-cache@v1
        with:
          working-directory: packages/core-bridge
      # Don't build during install phase since we're going to explicitly build
      - run: npm ci --ignore-scripts
      - run: npm run build
        env:
          BUILD_CORE_RELEASE: true

      - name: Download temporalite
        run: curl --fail -L http://temporal.download/assets/temporalio/temporalite/releases/download/v0.1.1/temporalite_0.1.1_linux_amd64.tar.gz | tar xz
      - name: Start temporalite
        run: nohup ./temporalite start --namespace default --ephemeral --headless & disown
        # TODO: get the server logs

      - run: mkdir -p $TEMPORAL_TESTING_LOG_DIR/tails
      - run: mkdir -p $TEMPORAL_TESTING_MEM_LOG_DIR
      - run: 'timeout ${{ inputs.test-timeout-minutes }}m npm run ${{ inputs.test-type }}'
      - run: for f in $TEMPORAL_TESTING_LOG_DIR/*.log; do tail -20000 $f > $TEMPORAL_TESTING_LOG_DIR/tails/$(basename $f); done
        if: ${{ always() }}
      - uses: actions/upload-artifact@v3
        if: ${{ always() }}
        with:
          name: worker-logs
          path: ${{ env.TEMPORAL_TESTING_LOG_DIR }}/tails
      - uses: actions/upload-artifact@v3
        if: ${{ always() }}
        with:
          name: worker-mem-logs
          path: ${{ env.TEMPORAL_TESTING_MEM_LOG_DIR }}

      # TODO: set up alerting
      # TODO: record test durations and other metrics like memory usage / cache utilization / CPU
